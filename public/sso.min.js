/**
 * @time 2019.8.27
 */
! function (t) {
    function n(e) {
        if (r[e]) return r[e].exports;
        var i = r[e] = {
            exports: {},
            id: e,
            loaded: !1
        };
        return t[e].call(i.exports, i, i.exports, n), i.loaded = !0, i.exports;
    };
    var r = {};
    return n.m = t, n.c = r, n.p = "", n(0);
}([function (t, n, r) {
    r(1)(window)
}, function (t, n) {
    t.exports = function (t) {
        var n = "RealXMLHttpRequest";
        t.hookAjax = function (t) {
            function r(n) {
                return function () {
                    var r = this.hasOwnProperty(n + "_") ? this[n + "_"] : this.xhr[n],
                        e = (t[n] || {}).getter;
                    return e && e(r, this) || r;
                }
            };

            function e(n) {
                return function (r) {
                    var e = this.xhr,
                        i = this,
                        o = t[n];
                    if ("function" == typeof o) e[n] = function () {
                        t[n](i) || r.apply(e, arguments)
                    };
                    else {
                        var u = (o || {}).setter;
                        r = u && u(r, i) || r;
                        try {
                            e[n] = r
                        } catch (t) {
                            this[n + "_"] = r;
                        }
                    }
                }
            };

            function i(n) {
                return function () {
                    var r = [].slice.call(arguments);
                    if (!t[n] || !t[n].call(this, r, this.xhr)) return this.xhr[n].apply(this.xhr, r);
                }
            };
            return window[n] = window[n] || XMLHttpRequest, XMLHttpRequest = function () {
                var t = new window[n];
                for (var o in t) {
                    var u = "";
                    try {
                        u = typeof t[o];
                    } catch (t) {}
                    "function" === u ? this[o] = i(o) : Object.defineProperty(this, o, {
                        get: r(o),
                        set: e(o),
                        enumerable: !0
                    });
                };
                this.xhr = t;
            }, window[n]
        }, t.unHookAjax = function () {
            window[n] && (XMLHttpRequest = window[n]), window[n] = void 0
        }, t.default = t;
    };
}]);
var _r = new XMLHttpRequest();
var _in = 0;
window.ysgz = {
    loginUrl: '',
    urlList: []
};
function getCookie(cname) {
    var name = cname + "=";
    let token = '';
    var ca = document.cookie.split(';');
    for(var i=0; i<ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1);
        if (c.indexOf(name) != -1) {
            token = c.substring(name.length, c.length);
            break;
        }
    }
    if (token) {
        return token;
    } else {
        return '';
    }
}
function setCookie(name,value){
    var Days = 1;
    var exp = new Date();
    exp.setTime(exp.getTime() + Days*24*60*60*30);
    document.cookie = name + "="+ encodeURIComponent (value) + ";expires=" + exp.toGMTString() + "; path=/;";
}
function _h(m, u, callback) {
    if (m == 'GET') {
        _r.open(m, u, true);
        _r.send();
    } else if (m == 'POST') {
        _r.open(m, u, true);
        _r.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        _r.send("fname=Henry&lname=Ford");
    };
    _r.onreadystatechange = function (e) {
        if (_r.readyState == 4 && _r.status == 200) {
            callback(JSON.parse(_r.responseText));
        }
    };
};

function _a() {
    _h('POST', window.ysgz.baseUrl + '/sso/auth?hytoken=' + getCookie('hytoken'), function (d) {
        if (d.returnCode == '003') {
            window.location.href = ysgz.loginUrl + '?backurl=' + encodeURIComponent(window.location.href)
        } else {
            setCookie('hytoken', d.data);
        }
    });
};

_h('GET', window.ecpJson, function (d) {
    window.ysgz = d;
    if (d.ssoLock) {
        if (getCookie('hytoken')) {
            hookAjax({
                open: function (arg, xhr) {
                    // 白名单
                    if(d.whiteList && d.whiteList instanceof Array){
                        if(d.whiteList.find(item=>{
                            return arg[1].indexOf(item)!=-1
                        })){
                            return;
                        }
                    }
                    if (arg[1].indexOf('?') > 0) {
                        arg[1] += '&hytoken=' + getCookie('hytoken');
                    } else {
                        arg[1] += '?hytoken=' + getCookie('hytoken');
                    }
                },
            })
        _a();
        setInterval(() => {
            _a();
        }, 8 * 60 * 1000)
        } else {
            if (window.ysgz.loginUrl) {
                window.location.href = window.ysgz.loginUrl + '?backurl=' + encodeURIComponent(window.location.href)
            }
        }
    }
});
